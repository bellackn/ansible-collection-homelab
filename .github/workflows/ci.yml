---
name: CI

"on":
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  lint:
    name: Run linters
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v3

      # we need '../' so the actual role can be tested, and '/tmp' is where dependencies will be installed
      - name: Create ansible.cfg
        run: >
          printf '[defaults]\nroles_path=../:/tmp'
          > roles/proxmox_lxc/ansible.cfg

      - name: Set up Python 3.10
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"
          cache: pip

      - name: Install test dependencies
        run: |
          pip install wheel --upgrade
          pip install --upgrade ansible ansible-lint yamllint

      - name: Install Galaxy requirements
        run: |
          cd roles/proxmox_lxc
          ansible-galaxy role install -r tests/requirements.yml -p /tmp
          ansible-galaxy collection install -r tests/requirements.yml -p /tmp

      - name: Run yamllint
        run: yamllint .

      - name: Run ansible-lint
        run: ansible-lint

      - name: Test syntax
        run: |
          cd roles/proxmox_lxc
          ansible-playbook tests/test.yml -i tests/inventory --syntax-check

  ansible-test:
    name: Run ansible-test
    runs-on: ubuntu-latest
    steps:
      - name: Perform sanity testing with ansible-test
        uses: ansible-community/ansible-test-gh-action@release/v1
        with:
          testing-type: sanity

  galaxy:
    name: Build collection
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v3

      - name: Build collection tarball
        uses: artis3n/ansible_galaxy_collection@v2
        with:
          api_key: '${{ secrets.GALAXY_API_KEY }}'
          publish: false
